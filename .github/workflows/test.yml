name: Jekyll site CI

on:
  push:
    branches:
      - "master"
    paths:
      - 'pet/**'

env:  
  PACKAGES_FOLDER: Modules

jobs:
  build:
  
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: Verify Changed files
      uses: tj-actions/verify-changed-files@v10.1
      id: verify-changed-adminapp
      with:
        files: |
          pet/**

    - name: Run step only when files change.
      if: steps.verify-changed-files.outputs.files_changed == 'true'
      run: |
        echo "Changed files: ${{ steps.verify-changed-files.outputs.changed_files }}"
        # Outputs: "Changed files: new.txt test_directory/new.txt"  
    - name: test2
      run: |
        echo ${{ github.run_number }}
    - name: Install a SQL Server suite of tools
      uses: potatoqualitee/mssqlsuite@v1.5.1
      with:
        install: sqlengine, sqlclient, sqlpackage, localdb
    
    - name: Install Tabular Editor
      run: |
        $TabularEditorUrl = "https://cdn.tabulareditor.com/files/te2/TabularEditor.Portable.zip" 
        $DownloadDestination = join-path (get-location) "TabularEditor.zip"
        Invoke-WebRequest -Uri $TabularEditorUrl -OutFile $DownloadDestination
        Expand-Archive -Path $DownloadDestination -DestinationPath (get-location).Path
        Remove-Item $DownloadDestination
    
    - name: Make Install Modules Folder
      run: New-Item "$PSScriptRoot\${env:PACKAGES_FOLDER}" -ItemType Directory -Force

    - name: Install Redgate Tooling
      run: |
        $LocalModules = "$PSScriptRoot\${env:PACKAGES_FOLDER}"
        Get-PackageProvider NuGet -ForceBootstrap | Out-Null
        Import-PackageProvider PowerShellGet 
        Save-Module -Name PowerShellGet -Path $LocalModules -MinimumVersion 1.6 -Force -ErrorAction SilentlyContinue
        Save-Module -Name SqlChangeAutomation -Path $LocalModules -Force -ErrorAction Stop -AcceptLicense        
    
    - name: Test
      run: |
        python --version
        py -m pip install pyodbc
        #Install-Module -Name PowerShellGet -MinimumVersion 2.0.1
        #Install-Module -Name SqlChangeAutomation
        #Import-Module SqlChangeAutomation
    
    - name: Build Redgate Packages      
      run: |
        $LocalModules = "$PSScriptRoot\${env:PACKAGES_FOLDER}"
        $env:PSModulePath = "$LocalModules;$env:PSModulePath"

        Import-Module SqlChangeAutomation
